# トラブル相談アプリ - 月間コスト試算

## 使用サービス

- **OpenAI API**: gpt-4.1-nano-2025-04-14
- **Vercel**: 有料プラン（Pro）
- **AWS Lightsail Database**: MySQL 8.0.43

---

## OpenAI API 料金（gpt-4.1-nano-2025-04-14）

> ※2025年12月時点の料金

| トークンタイプ | 料金 |
|--------------|------|
| 入力トークン | $0.15 / 1M tokens |
| 出力トークン | $0.60 / 1M tokens |

---

## 1回の相談あたりの想定トークン数

### 通常の相談メッセージ

- **システムプロンプト**: 約500トークン（固定）
- **ユーザーメッセージ履歴**: 平均200トークン/メッセージ × 履歴数
- **新規ユーザーメッセージ**: 平均100トークン
- **AI応答**: 平均300トークン（max_tokens: 1000）

**1往復あたりの平均:**
- 入力: 約800トークン（システム500 + 履歴200 + 新規100）
- 出力: 約300トークン

### タイトル自動生成（初回のみ）

- 入力: 約600トークン（システム + ユーザーメッセージ）
- 出力: 約20トークン

---

## 1ユーザーあたりの月間想定使用量

### アクティブユーザーの想定

- **月間相談回数**: 10回
- **1相談あたりの往復**: 5往復
- **合計往復数**: 50往復/月

### トークン計算

**通常相談:**
- 入力: 800トークン × 50往復 = 40,000トークン
- 出力: 300トークン × 50往復 = 15,000トークン

**タイトル生成（月1回）:**
- 入力: 600トークン
- 出力: 20トークン

**合計:**
- 入力: 40,600トークン/月
- 出力: 15,020トークン/月

### 1ユーザーあたりのコスト

- 入力: 40,600 ÷ 1,000,000 × $0.15 = $0.00609 ≈ **¥0.91**
- 出力: 15,020 ÷ 1,000,000 × $0.60 = $0.00901 ≈ **¥1.35**

**合計: 約¥2.26/月/ユーザー**

---

## ユーザー数別 月間コスト試算

> ※為替レート: $1 = ¥150 で計算  
> ※Vercel Pro: ¥3,000/月 を含む

| ユーザー数 | OpenAI API | Vercel Pro | 合計 |
|-----------|-----------|-----------|------|
| 10人 | ¥23 | ¥3,000 | **¥3,023** |
| 50人 | ¥113 | ¥3,000 | **¥3,113** |
| 100人 | ¥226 | ¥3,000 | **¥3,226** |
| 200人 | ¥452 | ¥3,000 | **¥3,452** |
| 500人 | ¥1,130 | ¥3,000 | **¥4,130** |
| 1,000人 | ¥2,260 | ¥3,000 | **¥5,260** |
| 2,000人 | ¥4,520 | ¥3,000 | **¥7,520** |
| 5,000人 | ¥11,300 | ¥3,000 | **¥14,300** |
| 10,000人 | ¥22,600 | ¥3,000 | **¥25,600** |

---

## コスト内訳の詳細

### 10ユーザーの場合

**OpenAI:**
- 入力: 40,600 × 10 = 406,000トークン → $0.06 → ¥9
- 出力: 15,020 × 10 = 150,200トークン → $0.09 → ¥14

**Vercel:** ¥3,000  
**合計:** ¥3,023

### 100ユーザーの場合

**OpenAI:**
- 入力: 40,600 × 100 = 4,060,000トークン → $0.61 → ¥91
- 出力: 15,020 × 100 = 1,502,000トークン → $0.90 → ¥135

**Vercel:** ¥3,000  
**合計:** ¥3,226

### 1,000ユーザーの場合

**OpenAI:**
- 入力: 40,600 × 1,000 = 40,600,000トークン → $6.09 → ¥914
- 出力: 15,020 × 1,000 = 15,020,000トークン → $9.01 → ¥1,352

**Vercel:** ¥3,000  
**合計:** ¥5,266

### 10,000ユーザーの場合

**OpenAI:**
- 入力: 40,600 × 10,000 = 406,000,000トークン → $60.90 → ¥9,135
- 出力: 15,020 × 10,000 = 150,200,000トークン → $90.12 → ¥13,518

**Vercel:** ¥3,000  
**合計:** ¥25,653

---

## 利用パターン別のコスト変動

| ユーザータイプ | 月間往復数 | OpenAI コスト |
|--------------|-----------|--------------|
| ライトユーザー | 5往復 | 約¥0.23/月 |
| 通常ユーザー | 50往復 | 約¥2.26/月 |
| ヘビーユーザー | 200往復 | 約¥9.04/月 |

---

## コスト最適化のポイント

### 1. モデル選択

✅ **現在使用中**: gpt-4.1-nano-2025-04-14（最も安価なGPT-4モデル）
- これ以上のコスト削減は難しい（品質を保つ場合）

### 2. トークン使用量の削減

- システムプロンプトの簡略化（現在約500トークン）
- 履歴の保持数を制限（現在は全履歴を送信）
- max_tokensの調整（現在1000→500に減らすことも可能）

### 3. キャッシング機能の活用（将来的）

- OpenAIのPrompt Cachingを使えば、システムプロンプトのコストを50%削減可能

### 4. 使用量制限

- 1ユーザーあたりの月間相談回数制限
- 1相談あたりの往復数制限

---

## データベース容量とパフォーマンスの試算

### 現在の環境

- **データベース**: AWS Lightsail Database (MySQL 8.0.43)
- **リージョン**: ap-northeast-1 (東京)
- **現在のデータ量**: 約0.43MB
- **詳細**: [DATABASE_STATUS.md](./DATABASE_STATUS.md) を参照

### 1ユーザーあたりのデータ量試算

#### テーブル構造とデータサイズ

| テーブル | 1レコード | 月間レコード数 | 月間データ量 |
|---------|----------|--------------|-------------|
| User | 200バイト | 1件 | 200バイト |
| ChatRoom | 150バイト | 10件 | 1,500バイト |
| Message | 500バイト | 100件 | 50,000バイト |
| AccessLog | 100バイト | 50件 | 5,000バイト |
| **合計** | - | - | **約55KB/月** |

> **重要**: Messageテーブルが全体の約88%を占める

---

## ユーザー数別のデータベース容量試算

### 月間増加量

| ユーザー数 | 月間増加量 | 年間増加量 | 3年間累計 |
|-----------|-----------|-----------|-----------|
| 100人 | 5.5 MB | 66 MB | 198 MB |
| 500人 | 27.5 MB | 330 MB | 990 MB |
| 1,000人 | 55 MB | 660 MB | 1.98 GB |
| 2,000人 | 110 MB | 1.32 GB | 3.96 GB |
| 5,000人 | 275 MB | 3.30 GB | 9.90 GB |
| 10,000人 | 550 MB | 6.60 GB | 19.80 GB |

### 実質的な容量（インデックス・オーバーヘッド込み）

> 実際のストレージ使用量は上記の1.5〜2倍程度

| ユーザー数 | 月間増加量 | 年間増加量 | 3年間累計 |
|-----------|-----------|-----------|-----------|
| 100人 | 8-11 MB | 100-130 MB | 300-400 MB |
| 500人 | 41-55 MB | 500-660 MB | 1.5-2.0 GB |
| 1,000人 | 83-110 MB | 1.0-1.3 GB | 3.0-4.0 GB |
| 2,000人 | 165-220 MB | 2.0-2.6 GB | 6.0-8.0 GB |
| 5,000人 | 413-550 MB | 5.0-6.6 GB | 15.0-20.0 GB |
| 10,000人 | 825-1100 MB | 10.0-13.2 GB | 30.0-40.0 GB |

---

## AWS Lightsail Database の料金

### プラン別料金表

| プラン | 月額料金 | スペック | 適用範囲 |
|--------|---------|---------|---------|
| Standard | $15/月<br>(¥2,250) | 1GB RAM<br>40GB SSD<br>100GB転送量 | 〜500ユーザー |
| High Performance | $30/月<br>(¥4,500) | 2GB RAM<br>80GB SSD<br>100GB転送量 | 500〜2,000ユーザー |
| High Availability | $60/月<br>(¥9,000) | 4GB RAM<br>160GB SSD<br>200GB転送量 | 2,000〜5,000ユーザー |

---

## ユーザー数別の総コスト試算（DB料金含む）

| ユーザー数 | OpenAI | Vercel | Database | **合計** |
|-----------|--------|--------|----------|---------|
| 100人 | ¥226 | ¥3,000 | ¥2,250 | **¥5,476** |
| 500人 | ¥1,130 | ¥3,000 | ¥2,250 | **¥6,380** |
| 1,000人 | ¥2,260 | ¥3,000 | ¥2,250 | **¥7,510** |
| 2,000人 | ¥4,520 | ¥3,000 | ¥4,500 | **¥12,020** |
| 5,000人 | ¥11,300 | ¥3,000 | ¥4,500 | **¥18,800** |
| 10,000人 | ¥22,600 | ¥3,000 | ¥9,000 | **¥34,600** |

---

## パフォーマンスの懸念点と対策

### 懸念点

#### 1. Message テーブルの肥大化
- 最もデータ量が多い（全体の約88%）
- チャット履歴が増えるほど検索が遅くなる可能性

#### 2. インデックスの効率
- 現在のインデックス:
  - `chat_room_id`
  - `created_at`
  - `chat_room_id + created_at`（複合）
- ✅ 適切に設定されている

#### 3. 同時接続数
- ピーク時のアクセス集中
- コネクションプールの管理

### 対策

#### 1. データのアーカイブ戦略

```
- 6ヶ月以上前の解決済みチャットを別テーブルに移動
- または、S3にエクスポートして削除
- 効果: メインテーブルのサイズを70-80%削減可能
```

#### 2. パーティショニング

```
- created_at でテーブルをパーティション分割
- 月単位または四半期単位で分割
- 効果: 古いデータへのクエリ性能を維持
```

#### 3. Read Replica の導入

```
- 読み取り専用のレプリカを作成
- チャット履歴の参照をレプリカに振り分け
- 効果: メインDBの負荷を50%程度削減
- 追加コスト: +¥2,000〜¥7,000/月
```

#### 4. キャッシュレイヤーの導入

```
- Redis/ElastiCacheでチャット履歴をキャッシュ
- 頻繁にアクセスされるデータをメモリに保持
- 効果: DB負荷を大幅削減、レスポンス高速化
- 追加コスト: ¥2,000〜¥5,000/月
```

#### 5. チャット履歴の制限

```
- APIで取得する履歴を直近50件に制限
- 古い履歴は「もっと見る」で遅延ロード
- 効果: クエリ負荷を大幅削減
```

---

## スケーラビリティの閾値

### ✅ 現在の構成で問題なく動作する範囲（〜1,000ユーザー）

- Lightsail Database Standard で十分
- 特別な対策不要

### ⚠️ 最適化を検討すべき範囲（1,000〜5,000ユーザー）

- Lightsail Database High Performance に移行
- アーカイブ戦略の実装を推奨
- インデックスの見直し

### 🔴 本格的なスケーリングが必要な範囲（5,000ユーザー以上）

- Lightsail Database High Availability 以上
- Read Replica の導入必須
- キャッシュレイヤーの導入推奨
- パーティショニングの検討
- 監視・アラートの強化

---

## 監視すべきメトリクス

| メトリクス | 正常範囲 | 警告 | 危険 | 対応策 |
|-----------|---------|------|------|--------|
| CPU使用率 | 〜50% | 50-80% | 80%以上 | インスタンスサイズアップ |
| メモリ使用率 | 〜60% | 60-85% | 85%以上 | クエリ最適化/サイズアップ |
| ストレージ使用率 | 〜50% | 50-70% | 70%以上 | ストレージ拡張/アーカイブ |
| 接続数 | 〜50% | 50-80% | 80%以上 | コネクションプール見直し |
| クエリ実行時間 | 〜100ms | 100-500ms | 500ms以上 | インデックス追加/最適化 |
| レプリケーション遅延 | 〜1秒 | 1-5秒 | 5秒以上 | ネットワーク調査/サイズアップ |

---

## まとめ

### 結論

#### OpenAI API + Vercel のみの場合
- ✅ 1,000ユーザーまでは月額¥5,300程度で運用可能
- ✅ OpenAI APIのコストは非常に低く、主なコストはVercel Pro（¥3,000）
- ✅ ユーザー数が増えても、OpenAI APIのコストは線形に増加
- ✅ 10,000ユーザーでも月額¥25,600程度と、スケーラブルなコスト構造

#### データベース込みの総コスト
- ✅ 1,000ユーザーまでは月額¥7,500程度で運用可能
- ✅ データ量: 3年で約4GB（オーバーヘッド込み）
- ✅ パフォーマンス: Lightsail Database Standard で十分対応可能

#### 1,000〜5,000ユーザー
- データ量: 3年で約20GB
- 月間コスト: 約¥19,000〜¥22,000
- 対策: アーカイブ戦略、インスタンスサイズアップ

#### 5,000ユーザー以上
- データ量: 3年で40GB以上
- 月間コスト: ¥35,000以上
- 対策: Read Replica、キャッシュ、パーティショニング必須

### 最重要ポイント

- ✅ **Message テーブルが全体の88%を占める**
- ✅ **6ヶ月以上前のデータをアーカイブすれば容量を70-80%削減可能**
- ✅ **監視を適切に設定し、閾値に達する前に対策を実施**

### 推奨アクション

#### 短期（現在〜500ユーザー）
1. 現状維持で問題なし
2. CloudWatch監視の設定（CPU、メモリ、ストレージ）
3. 定期的なバックアップの確認

#### 中期（500〜2,000ユーザー）
1. アーカイブ戦略の設計・実装
2. スロークエリログの監視開始
3. プラン変更の検討

#### 長期（2,000ユーザー以上）
1. Read Replicaの導入検討
2. キャッシュレイヤー（Redis/ElastiCache）の導入
3. パーティショニングの実装
4. 本格的なAWS RDSへの移行検討

---

## 注意事項

- 上記は平均的な使用を想定した試算です
- 実際のトークン数は相談内容により変動します
- 為替レートの変動により円換算額は変わります
- Vercelの料金は固定ですが、帯域幅や関数実行時間により追加料金が発生する可能性があります
- データベースの料金は概算であり、実際の使用状況により変動する可能性があります

---

**作成日**: 2025年12月26日  
**最終更新**: 2025年12月26日（DB容量とパフォーマンス試算を追加）



