# データベース状態レポート

## 📊 現在のデータベース構成

### AWS RDS MySQL の基本情報

| 項目               | 内容                                                                                        |
| ------------------ | ------------------------------------------------------------------------------------------- |
| **プロバイダー**   | AWS Lightsail Database (推定)                                                               |
| **データベース**   | MySQL 8.0.43                                                                                |
| **リージョン**     | ap-northeast-1 (東京)                                                                       |
| **データベース名** | trouble                                                                                     |
| **接続方式**       | SSL必須                                                                                     |
| **ホスト**         | `ls-9a89c857a23ddab71bd63551ccb0d15591ea12d4.cz4ag262gfne.ap-northeast-1.rds.amazonaws.com` |

> **注**: ホスト名が `ls-` で始まることから、AWS Lightsail Database を使用していると推定されます。

---

## 📈 現在のデータ量（2025年12月26日時点）

### テーブル別レコード数とサイズ

| テーブル  | レコード数 | 推定サイズ  | 備考                           |
| --------- | ---------- | ----------- | ------------------------------ |
| User      | 4件        | 0.78 KB     | ユーザーアカウント             |
| Token     | 53件       | 7.76 KB     | 認証キー（49件未使用）         |
| ChatRoom  | 211件      | 30.91 KB    | 相談ルーム                     |
| Message   | 409件      | **0.20 MB** | チャットメッセージ（最大容量） |
| AccessLog | 48件       | 4.69 KB     | アクセスログ                   |
| **合計**  | **725件**  | **0.24 MB** | データのみ                     |

**推定実容量**（インデックス・オーバーヘッド込み）: **約0.43 MB**

---

## 👥 ユーザー統計

### 利用状況

- **アクティブユーザー数**: 4人
- **平均チャットルーム数**: 52.75件/ユーザー
- **平均メッセージ数**: 102.25件/ユーザー
- **チャットルームあたりメッセージ数**: 1.94件/ルーム

### 最新のアクティビティ

- **最新ユーザー登録**: 2025/12/25 14:11:25
- **最新チャット**: 「隣の騒音問題」(2025/12/25 13:35:51)
- **最新メッセージ**: 2025/12/25 13:43:02

---

## 📊 ステータス別内訳

### チャットルームのステータス

| ステータス           | 件数      | 割合     |
| -------------------- | --------- | -------- |
| 相談中 (IN_PROGRESS) | 151件     | 71.6%    |
| 解決済み (RESOLVED)  | 57件      | 27.0%    |
| 電話相談 (ESCALATED) | 3件       | 1.4%     |
| **合計**             | **211件** | **100%** |

### トークンのステータス

| ステータス      | 件数     | 割合     |
| --------------- | -------- | -------- |
| 使用中 (ACTIVE) | 4件      | 7.5%     |
| 未使用 (UNUSED) | 49件     | 92.5%    |
| **合計**        | **53件** | **100%** |

---

## 💰 現在のプラン推定

### AWS Lightsail Database 料金

現在使用していると推定されるプラン：

| プラン                     | 月額料金             | スペック                            | 適用範囲             |
| -------------------------- | -------------------- | ----------------------------------- | -------------------- |
| **Standard（推定使用中）** | $15/月<br>(約¥2,250) | 1GB RAM<br>40GB SSD<br>100GB転送量  | 〜500ユーザー        |
| High Performance           | $30/月<br>(約¥4,500) | 2GB RAM<br>80GB SSD<br>100GB転送量  | 500〜2,000ユーザー   |
| High Availability          | $60/月<br>(約¥9,000) | 4GB RAM<br>160GB SSD<br>200GB転送量 | 2,000〜5,000ユーザー |

> **現在のデータ量**: 0.43MB → 40GBの **0.001%未満**

---

## ✅ 現状の評価

### 容量面

| 項目             | 状態              | 詳細                   |
| ---------------- | ----------------- | ---------------------- |
| 現在の使用量     | ✅ 優秀           | 0.43MB / 40GB (0.001%) |
| 1,000ユーザー時  | ✅ 問題なし       | 約4GB / 40GB (10%)     |
| 5,000ユーザー時  | ⚠️ 要検討         | 約20GB / 40GB (50%)    |
| 10,000ユーザー時 | 🔴 プラン変更必要 | 約40GB / 40GB (100%)   |

### パフォーマンス面

| 項目         | 状態        | 詳細                               |
| ------------ | ----------- | ---------------------------------- |
| 現在の動作   | ✅ 快適     | 4ユーザー、409メッセージで問題なし |
| インデックス | ✅ 適切     | 必要なインデックスは設定済み       |
| クエリ性能   | ✅ 良好     | 最適化されたクエリ構造             |
| 同時接続     | ✅ 余裕あり | 現在の負荷は極めて低い             |

### コスト面（月額）

| 項目                   | 金額       |
| ---------------------- | ---------- |
| AWS Lightsail Database | ¥2,250     |
| Vercel Pro             | ¥3,000     |
| OpenAI API (4ユーザー) | ¥9         |
| **合計**               | **¥5,259** |

---

## 📊 スケーラビリティ予測

### ユーザー数別の容量予測

| ユーザー数 | 月間増加量  | 年間増加量   | 3年間累計    | 推奨プラン              |
| ---------- | ----------- | ------------ | ------------ | ----------------------- |
| 100人      | 8-11 MB     | 100-130 MB   | 300-400 MB   | Standard ($15)          |
| 500人      | 41-55 MB    | 500-660 MB   | 1.5-2.0 GB   | Standard ($15)          |
| 1,000人    | 83-110 MB   | 1.0-1.3 GB   | 3.0-4.0 GB   | Standard ($15)          |
| 2,000人    | 165-220 MB  | 2.0-2.6 GB   | 6.0-8.0 GB   | High Performance ($30)  |
| 5,000人    | 413-550 MB  | 5.0-6.6 GB   | 15.0-20.0 GB | High Performance ($30)  |
| 10,000人   | 825-1100 MB | 10.0-13.2 GB | 30.0-40.0 GB | High Availability ($60) |

> **重要**: Messageテーブルが全体の約88%を占めるため、古いデータのアーカイブで容量を70-80%削減可能

---

## 🎯 推奨アクション

### 短期（現在〜500ユーザー）

- ✅ **現状維持で問題なし**
- CloudWatch監視の設定（CPU、メモリ、ストレージ）
- 定期的なバックアップの確認

### 中期（500〜2,000ユーザー）

- アーカイブ戦略の設計
  - 6ヶ月以上前の解決済みチャットをS3に移動
  - または別テーブルに分離
- スロークエリログの監視開始
- プラン変更の検討（High Performance: $30/月）

### 長期（2,000ユーザー以上）

- Read Replicaの導入検討
- キャッシュレイヤー（Redis/ElastiCache）の導入
- パーティショニングの実装
- 本格的なAWS RDSへの移行検討

---

## 🔍 監視すべきメトリクス

### 重要な指標と閾値

| メトリクス       | 正常範囲 | 警告      | 危険      | 対応策                    |
| ---------------- | -------- | --------- | --------- | ------------------------- |
| CPU使用率        | 〜50%    | 50-80%    | 80%以上   | インスタンスサイズアップ  |
| メモリ使用率     | 〜60%    | 60-85%    | 85%以上   | クエリ最適化/サイズアップ |
| ストレージ使用率 | 〜50%    | 50-70%    | 70%以上   | ストレージ拡張/アーカイブ |
| 接続数           | 〜50%    | 50-80%    | 80%以上   | コネクションプール見直し  |
| クエリ実行時間   | 〜100ms  | 100-500ms | 500ms以上 | インデックス追加/最適化   |

---

## 📝 データベーススキーマ

### テーブル構造

```
User (ユーザー)
├─ id: INT (PK)
├─ email: VARCHAR (UNIQUE)
├─ password: VARCHAR (bcrypt hash)
├─ token_id: INT (FK → Token)
├─ is_admin: BOOLEAN
└─ created_at: DATETIME

Token (認証キー)
├─ id: INT (PK)
├─ token_value: VARCHAR (UNIQUE)
├─ status: ENUM (UNUSED, ACTIVE, REVOKED)
├─ assigned_to: INT (FK → User)
└─ created_at: DATETIME

ChatRoom (相談ルーム)
├─ id: INT (PK)
├─ user_id: INT (FK → User)
├─ title: VARCHAR(100)
├─ status: ENUM (IN_PROGRESS, RESOLVED, ESCALATED)
├─ created_at: DATETIME
└─ resolved_at: DATETIME

Message (メッセージ) ※最大容量
├─ id: INT (PK)
├─ chat_room_id: INT (FK → ChatRoom)
├─ sender: VARCHAR(50)
├─ body: TEXT
└─ created_at: DATETIME

AccessLog (アクセスログ)
├─ id: INT (PK)
├─ user_id: INT (FK → User)
├─ event: VARCHAR(100)
└─ created_at: DATETIME
```

### インデックス設定

```sql
-- User
UNIQUE INDEX: email
UNIQUE INDEX: token_id

-- Token
UNIQUE INDEX: token_value
INDEX: assigned_to

-- ChatRoom
INDEX: user_id
INDEX: created_at
INDEX: status
INDEX: (user_id, status) -- 複合インデックス

-- Message
INDEX: chat_room_id
INDEX: created_at
INDEX: (chat_room_id, created_at) -- 複合インデックス

-- AccessLog
INDEX: user_id
```

---

## 🚨 注意事項

### セキュリティ

- ✅ SSL接続必須で設定済み
- ✅ パスワードはbcryptでハッシュ化
- ⚠️ データベース認証情報は環境変数で管理（`.env`ファイルは`.gitignore`に追加済みか要確認）

### バックアップ

- AWS Lightsail Databaseは自動バックアップ機能あり（要確認）
- 推奨: 日次自動バックアップ、7日間保持
- 重要: 本番環境への移行前に手動バックアップを取得

### パフォーマンス

- 現在のクエリは最適化されている
- チャット履歴取得時は必要な範囲のみ取得
- トランザクション処理で整合性を保証

---

## 📅 更新履歴

| 日付       | 内容                                          |
| ---------- | --------------------------------------------- |
| 2025/12/26 | 初版作成 - 現在のDB状態を調査・ドキュメント化 |

---

**作成日**: 2025年12月26日  
**最終更新**: 2025年12月26日
