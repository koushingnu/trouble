version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "DATABASE_URL=$DATABASE_URL" > .env
        - echo "NEXTAUTH_URL=$NEXTAUTH_URL" >> .env
        - echo "NEXTAUTH_SECRET=$NEXTAUTH_SECRET" >> .env
        - echo "OPENAI_API_KEY=$OPENAI_API_KEY" >> .env
        - npm ci
    build:
      commands:
        - npx prisma generate
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - "**/*"
    discard-paths: no
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
  customHeaders:
    - pattern: "**/*"
      headers:
        - key: "Strict-Transport-Security"
          value: "max-age=31536000; includeSubDomains"
        - key: "X-Frame-Options"
          value: "DENY"
        - key: "X-Content-Type-Options"
          value: "nosniff"
        - key: "X-XSS-Protection"
          value: "1; mode=block"
        - key: "Referrer-Policy"
          value: "strict-origin-when-cross-origin"
        - key: "Content-Security-Policy"
          value: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://*.amplifyapp.com https://*.amazonaws.com;"
    - pattern: "/api/*"
      headers:
        - key: "Cache-Control"
          value: "no-store, no-cache, must-revalidate, proxy-revalidate"
        - key: "Pragma"
          value: "no-cache"
        - key: "Expires"
          value: "0"
  logging:
    level: info
    format: json
    storage:
      cloudWatch:
        region: ap-northeast-1
        logGroup: /aws/amplify/trouble-production
        logStreams:
          - name: application-logs
          - name: access-logs
          - name: error-logs