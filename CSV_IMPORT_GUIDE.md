# CSVインポート機能 ガイド

## 📋 概要

管理画面から契約情報CSVをアップロードして、認証キーとステータスを一括登録・更新できる機能です。

---

## 🎯 機能

### 1. **CSVファイルのアップロード**
- Shift-JISまたはUTF-8エンコーディングに対応
- ファイルサイズ制限: 最大4.5MB（Vercel制限）
- 処理時間制限: 最大60秒（Vercel Pro）

### 2. **データ抽出**
以下のフィールドを抽出してDBに登録します：

| フィールド名 | 列位置 | 必須 | 説明 |
|------------|--------|------|------|
| **認証キー** | 15列目 | ✅ 必須* | UUID形式の認証キー（`token_value`） |
| **顧客ID** | 13列目 | ✅ 必須* | 顧客ID（認証キーが空の場合に使用） |
| **電話番号** | 12列目 | 任意 | ハイフンなし10-11桁の電話番号 |
| **ステータス** | 6列目 | 任意 | 契約状態（承認/契約/退会/解約など） |

*認証キーまたは顧客IDのどちらか一方が必須です。

### 3. **ステータスマッピング**

| CSVの値 | DBのステータス | 説明 |
|---------|---------------|------|
| `承認` または `契約` | `ACTIVE` | 使用中 |
| `退会` または `解約` | `REVOKED` | 無効 |
| その他 | `UNUSED` | 未使用 |

### 4. **処理ロジック**

1. **認証キーが既存の場合**
   - ステータスを更新

2. **認証キーが新規の場合**
   - 新しい認証キーを作成

3. **電話番号がある場合**
   - 該当する使用中ユーザーの電話番号を更新（未設定の場合のみ）

---

## 📁 CSVフォーマット

### 実際のCSVフォーマット（契約管理システムからエクスポート）

```csv
"契約レコードSEQ","企業コード","法人名","個店コード","個店名","ステータス","決済","商品名","料金","ユ−ザ−ID","管理ID","電話番号","顧客ID","トラッキングID","認証キー","契約日","課金日","解約日","解約種別","解約理由","解約理由(その他)","再請求結果","予備１","予備２","予備３","予備４"
"999999","0623","テスト会社","0800","テストショップ","承認","クレジットカード","トラブルまるごと","660","TEST001","","07012345678","test-customer-001","","4b98ef46-f837-11f0-a13d-9ca3ba2c942e","2026-01-29","2026-03-01","","","","","","","","",""
"999998","0623","サンプル株式会社","0800","サンプル店舗","契約","クレジットカード","トラブルまるごと","660","TEST002","","09087654321","test-customer-002","","test-key-12345678-abcd-ef01-2345-67890abcdef0","2026-01-29","2026-03-01","","","","","","","","",""
"999997","0623","退会テスト会社","0800","退会テスト店舗","解約","クレジットカード","トラブルまるごと","660","TEST003","","08011112222","test-customer-003","","test-key-87654321-dcba-fe10-5432-0fedcba09876","2026-01-29","2026-03-01","2026-01-29","本人理由","サービスを利用しなかったため","","","","","",""
```

### 重要な列

| 列番号 | 列名 | 説明 |
|--------|------|------|
| 6 | ステータス | 承認/契約/解約/退会 |
| 12 | 電話番号 | ユーザーの電話番号 |
| 13 | 顧客ID | 顧客識別ID（認証キーの代替） |
| 15 | 認証キー | UUID形式の認証キー |

### 注意事項

- ✅ ヘッダー行（1行目）は必須です
- ✅ 認証キー（15列目）または顧客ID（13列目）のどちらかが必須
- ✅ 認証キーと顧客IDが両方とも空の行はスキップされます
- ✅ 電話番号は任意（空欄可）
- ✅ ステータスは任意（空欄の場合は「未使用」）
- ⚠️ 認証キーの重複は更新として処理されます
- 📝 認証キーが空の場合、顧客IDを認証キーとして使用します

---

## 🚀 使い方

### 1. 管理画面にアクセス

```
https://your-domain.com/admin
```

### 2. 「CSVインポート」タブを選択

管理画面の3つ目のタブ「CSVインポート」をクリックします。

### 3. CSVファイルを選択

「CSVファイルを選択」ボタンをクリックして、アップロードするCSVファイルを選択します。

### 4. アップロード実行

「アップロード」ボタンをクリックして、インポートを実行します。

### 5. 結果確認

インポート結果が表示されます：
- **総レコード数**: CSVの全行数
- **成功**: 正常に処理された件数
- **スキップ**: スキップされた件数（認証キーが空など）
- **エラー**: エラーが発生した件数

詳細ログで各行の処理結果を確認できます。

---

## 🔧 技術仕様

### API エンドポイント

```
POST /api/admin/import-csv
```

### リクエスト

```typescript
FormData {
  file: File (CSV)
}
```

### レスポンス

```typescript
{
  success: boolean;
  message: string;
  stats: {
    total: number;
    success: number;
    skipped: number;
    errors: number;
    details: string[];
  }
}
```

### 使用ライブラリ

- `csv-parse`: CSV解析
- `iconv-lite`: 文字エンコーディング変換（Shift-JIS対応）

---

## ⚠️ 制限事項

### Vercel制限

| 項目 | Hobby | Pro |
|------|-------|-----|
| リクエストボディサイズ | 4.5MB | 4.5MB |
| 関数実行時間 | 10秒 | 60秒 |
| 推奨レコード数 | ~500件 | ~2000件 |

### 推奨事項

- ✅ **大量データの場合**: CSVを分割してアップロード
- ✅ **定期実行の場合**: 差分データのみをアップロード
- ✅ **バックアップ**: インポート前にDBバックアップを推奨

---

## 🐛 トラブルシューティング

### エラー: 「ファイルが選択されていません」
→ CSVファイルを選択してからアップロードしてください

### エラー: 「管理者権限が必要です」
→ 管理者アカウントでログインしてください

### エラー: 「CSVインポート中にエラーが発生しました」
→ CSVのフォーマットを確認してください（ヘッダー行、文字エンコーディングなど）

### スキップが多い場合
→ 「認証キー」列が空の行が多い可能性があります。詳細ログを確認してください

---

## 📊 パフォーマンス

### 実測値（参考）

| レコード数 | 処理時間（目安） | ファイルサイズ |
|-----------|----------------|--------------|
| 100件 | ~2秒 | ~10KB |
| 500件 | ~8秒 | ~50KB |
| 1000件 | ~15秒 | ~100KB |
| 2000件 | ~30秒 | ~200KB |

※ 実際の処理時間はDB接続速度やサーバー負荷により変動します

---

## 🔐 セキュリティ

- ✅ 管理者権限チェック（`is_admin = true`）
- ✅ セッション認証（NextAuth.js）
- ✅ ファイルタイプ検証（`.csv`のみ）
- ✅ SQLインジェクション対策（Prisma ORM）

---

## 📝 サンプルファイル

プロジェクトルートに `sample-import.csv` を用意しています。
テスト用にご利用ください。

---

## 🎉 まとめ

CSVインポート機能により、契約情報の一括登録・更新が簡単に行えます。
Vercelの制限内で安全かつ効率的に処理できるように設計されています。

ご不明な点がございましたら、開発チームまでお問い合わせください。
