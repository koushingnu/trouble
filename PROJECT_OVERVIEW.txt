================================================================================
トラブルまるごとレスキュー隊 - プロジェクト概要
================================================================================

■ プロジェクト情報
  - アプリケーション名: トラブルまるごとレスキュー隊
  - 技術スタック: Next.js 15, TypeScript, Prisma, NextAuth.js, Tailwind CSS
  - データベース: PostgreSQL (AWS RDS)
  - デプロイ環境: AWS App Runner
  - ブランチ戦略:
    - production: 開発環境用（開発用AWSアカウント）
    - main: 本番環境用（本番用AWSアカウント）

================================================================================
■ 主要機能一覧
================================================================================

【1. 認証・ユーザー管理】
  ├─ ログイン機能 (/auth)
  │   - メールアドレス・パスワード認証
  │   - NextAuth.jsによるセッション管理
  │
  ├─ 新規登録機能 (/register)
  │   - 認証キーによる登録制限
  │   - パスワード: 5文字以上
  │   - メールアドレスの重複チェック
  │
  └─ パスワード再設定機能 (/reset-password)
      - 認証キーを使用したパスワードリセット
      - パスワード: 5文字以上

【2. AI相談チャット機能】
  ├─ 新規相談作成 (/consultation/new)
  │   - AI（Claude）とのリアルタイムチャット
  │   - 自動タイトル生成
  │   - ストリーミングレスポンス
  │
  ├─ 相談詳細・継続 (/consultation/[id])
  │   - 過去の相談履歴の表示
  │   - 相談の継続
  │   - ステータス管理（相談中/解決済み/電話相談）
  │   - 解決ボタンによる相談完了
  │
  └─ チャット機能
      - メッセージの送受信
      - AIによる自動応答
      - 電話相談への案内機能

【3. 相談履歴管理】
  └─ 相談履歴一覧 (/history)
      - サマリー表示（すべて/解決済み/相談中/電話相談）
      - ステータスフィルター機能
      - ページネーション（15件/ページ）
      - 相談日・タイトル・ステータス表示
      - 30秒ごとの自動更新

【4. マイページ】
  └─ ユーザー情報・統計 (/mypage)
      - ユーザー情報表示（メールアドレス）
      - 相談統計（総件数/解決済み/相談中/電話相談）
      - パスワード変更機能
      - ログアウト機能

【5. 管理者機能】
  └─ 管理画面 (/admin)
      ├─ ユーザー管理
      │   - ユーザー一覧表示
      │   - ユーザー検索（メールアドレス）
      │   - 管理者権限の付与/削除
      │   - ユーザー削除
      │   - CSV一括登録
      │
      └─ 認証キー管理
          - 認証キー一覧表示
          - 新規キー生成
          - キーステータス管理（未使用/使用済み/無効）
          - CSV一括生成・ダウンロード

【6. 静的ページ】
  ├─ 運営者情報 (/company)
  └─ プライバシーポリシー (/privacy)

================================================================================
■ データベース構造
================================================================================

【User テーブル】
  - id: ユーザーID（UUID）
  - email: メールアドレス（ユニーク）
  - password: ハッシュ化パスワード
  - is_admin: 管理者フラグ
  - created_at: 作成日時
  - updated_at: 更新日時

【Token テーブル】
  - id: トークンID（UUID）
  - token_value: 認証キー（ユニーク）
  - user_id: 紐付けユーザーID
  - status: ステータス（UNUSED/ACTIVE/INACTIVE）
  - created_at: 作成日時
  - updated_at: 更新日時

【ChatRoom テーブル】
  - id: チャットルームID（UUID）
  - user_id: ユーザーID
  - title: 相談タイトル
  - last_message: 最終メッセージ
  - status: ステータス（IN_PROGRESS/RESOLVED/ESCALATED）
  - created_at: 作成日時
  - updated_at: 更新日時

【ChatMessage テーブル】
  - id: メッセージID（UUID）
  - chat_room_id: チャットルームID
  - role: 送信者（user/assistant）
  - content: メッセージ内容
  - created_at: 作成日時

================================================================================
■ UI/UXデザイン
================================================================================

【カラースキーム】
  - プライマリ: #1888CF（青）
  - アクセント: #FF7BAC（ピンク）
  - 背景グラデーション: #ACE0F9 → #64B3F4
  - カード背景: #FDFDFD（白）
  - ステータス色:
    - 相談中: #FFF9C4（黄）
    - 解決済み: #E3F2FD（青）
    - 電話相談: #FFE4F1（ピンク）

【レイアウト】
  - レスポンシブデザイン（モバイルファースト）
  - 最大幅: 768px（中央配置）
  - 角丸: 24px（カード）
  - シャドウ: 統一されたドロップシャドウ

【ナビゲーション】
  - ヘッダーメニュー（固定）
    - 相談する
    - 相談履歴
    - マイページ
  - アクティブ状態の視覚的フィードバック

================================================================================
■ API エンドポイント一覧
================================================================================

【認証関連】
  POST   /api/auth/[...nextauth]      - NextAuth認証
  POST   /api/auth/reset-password     - パスワードリセット

【ユーザー関連】
  GET    /api/users/me                - 現在のユーザー情報取得
  POST   /api/users                   - ユーザー登録
  GET    /api/users                   - ユーザー一覧取得（管理者）
  PUT    /api/users                   - ユーザー情報更新（管理者）
  DELETE /api/users                   - ユーザー削除（管理者）
  POST   /api/users/csv               - ユーザーCSV一括登録（管理者）
  PUT    /api/users/password          - パスワード変更

【トークン関連】
  GET    /api/tokens                  - トークン一覧取得（管理者）
  POST   /api/tokens                  - トークン生成（管理者）
  PUT    /api/tokens                  - トークン更新（管理者）
  DELETE /api/tokens                  - トークン削除（管理者）
  POST   /api/tokens/csv              - トークンCSV生成（管理者）

【チャット関連】
  POST   /api/chat                    - メッセージ送信・AI応答
  GET    /api/chat/rooms              - チャットルーム一覧取得
  GET    /api/chat/rooms/[id]         - チャットルーム詳細取得
  PATCH  /api/chat/rooms/[id]         - チャットルームステータス更新
  GET    /api/chat/history            - チャット履歴取得

================================================================================
■ セキュリティ
================================================================================

【認証・認可】
  - NextAuth.jsによるセッション管理
  - JWTトークンベース認証
  - ミドルウェアによるルート保護
  - 管理者権限チェック

【パスワード】
  - bcryptによるハッシュ化（ストレングス: 10-12）
  - 最小文字数: 5文字

【データベース】
  - Prismaによる安全なクエリ実行
  - SQLインジェクション対策
  - トランザクション処理

【API】
  - CORSポリシー設定
  - レート制限（検討中）
  - 入力値バリデーション

================================================================================
■ パフォーマンス最適化
================================================================================

【データベース】
  - インデックス設定
    - User.email（ユニーク）
    - Token.token_value（ユニーク）
    - ChatRoom.user_id + created_at
    - ChatMessage.chat_room_id + created_at

【フロントエンド】
  - Next.js App Routerによる自動最適化
  - 画像最適化（next/image）
  - 動的インポート
  - クライアント側キャッシング

【API】
  - ストリーミングレスポンス（チャット）
  - ページネーション（相談履歴: 15件/ページ）
  - 自動更新の最適化（30秒間隔）

================================================================================
■ 開発・デプロイフロー
================================================================================

【開発環境】
  1. productionブランチで開発
  2. ローカルテスト
  3. 開発用AWSアカウントへ自動デプロイ（GitHub Actions）

【本番環境】
  1. productionブランチでテスト完了
  2. mainブランチへマージ
  3. 本番用AWSアカウントへ自動デプロイ（GitHub Actions）

【環境変数】
  - DATABASE_URL: PostgreSQL接続文字列
  - NEXTAUTH_SECRET: NextAuth秘密鍵
  - NEXTAUTH_URL: アプリケーションURL
  - ANTHROPIC_API_KEY: Claude API キー

================================================================================
■ 今後の拡張予定
================================================================================

【機能追加候補】
  - チャット履歴のエクスポート機能
  - 電話相談への引き継ぎフロー改善
  - 統計情報の詳細表示・グラフ化
  - 通知機能
  - メール送信機能（パスワードリセット等）

【技術的改善】
  - エラーログ収集・監視
  - パフォーマンスモニタリング
  - E2Eテストの追加
  - APIレート制限の実装

================================================================================
最終更新日: 2025年12月23日
================================================================================

